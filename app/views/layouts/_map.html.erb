<div id="map" style='width: 800px; height: 500px;'></div>

<script>
// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.

  function initMap() {
    var pos;
    var mapOptions = {
      center: pos,
      zoom: 14,
      styles: [{"elementType":"geometry","stylers":[{"hue":"#ff4400"},{"saturation":-68},{"lightness":-4},{"gamma":0.72}]},{"featureType":"road","elementType":"labels.icon"},{"featureType":"landscape.man_made","elementType":"geometry","stylers":[{"hue":"#0077ff"},{"gamma":3.1}]},{"featureType":"water","stylers":[{"hue":"#00ccff"},{"gamma":0.44},{"saturation":-33}]},{"featureType":"poi.park","stylers":[{"hue":"#44ff00"},{"saturation":-23}]},{"featureType":"water","elementType":"labels.text.fill","stylers":[{"hue":"#007fff"},{"gamma":0.77},{"saturation":65},{"lightness":99}]},{"featureType":"water","elementType":"labels.text.stroke","stylers":[{"gamma":0.11},{"weight":5.6},{"saturation":99},{"hue":"#0091ff"},{"lightness":-86}]},{"featureType":"transit.line","elementType":"geometry","stylers":[{"lightness":-48},{"hue":"#ff5e00"},{"gamma":1.2},{"saturation":-23}]},{"featureType":"transit","elementType":"labels.text.stroke","stylers":[{"saturation":-64},{"hue":"#ff9100"},{"lightness":16},{"gamma":0.47},{"weight":2.7}]}]
    };

    var map = new google.maps.Map(document.getElementById('map'), mapOptions);

    //pulling in assignee and todo coords from database
    var coords = <%= @coords_array.to_json.html_safe %>
    console.log(coords);
       
    var infoWindow = new google.maps.InfoWindow({map: map});

    for (var i = 0; i < coords.length; i++) {
        var data = coords[i];
        var myLatlng = new google.maps.LatLng(data.lat, data.lng);
        var icon_color;

         if (data.what == "assignee") {
            icon_color = data.assignee_img_url
          } else if (data.completed == true) {
            icon_color = 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
          } else {
            icon_color = 'https://maps.google.com/mapfiles/ms/icons/red-dot.png' 
          };

        var icon = {
            url: icon_color, // url
            scaledSize: new google.maps.Size(40, 40), // scaled size
            origin: new google.maps.Point(0,0), // origin
            anchor: new google.maps.Point(0, 0) // anchor
        };              

        var marker = new google.maps.Marker({
            position: myLatlng,
            map: map,
            todo_title: data.name,
            assignee: data.assignee_name,
            businessName: data.business_name,
            icon: icon,
            completed: data.completed
        });

        console.log(marker);
        //Attach click event to the marker.
        (function (marker, data) {
            google.maps.event.addListener(marker, "click", function (e) {
                //Wrap the content inside an HTML DIV in order to set height and width of InfoWindow.
                infoWindow.setContent("<div style = 'width:150px;min-height:40px;color:black'><strong>" + marker.businessName + "</strong><br><em>" + marker.todo_title + "</em><br>Assignee: <img src='" + data.img_url + "'><br>Completed: " + marker.completed + "</div>");
                infoWindow.open(map, marker);
            });
        })(marker, data);
      }

    // Try HTML5 geolocation.
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        var icon = {
            url: "assets/images/staricon.gif", // url
            scaledSize: new google.maps.Size(40, 40), // scaled size
            origin: new google.maps.Point(0,0), // origin
            anchor: new google.maps.Point(0, 0) // anchor
        };

        var currentMarker = new google.maps.Marker({
            position: pos,
            map: map,
            icon: icon
        });

        // infoWindow.setPosition(pos);
        // infoWindow.setContent("<div style = 'width:45px;min-height:10px;color:black'>Here</div>");
        map.setCenter(pos);
      }, function() {
        handleLocationError(true, infoWindow, map.getCenter());
      });
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }

    console.log(pos);
  } //end of initMap function

  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
                          'Error: The Geolocation service failed.' :
                          'Error: Your browser doesn\'t support geolocation.');
  }


// $("input").geocomplete();

// // Trigger geocoding request.
// $("button.find").click(function(){
//   $("input").trigger("geocode");
//   console.log(this)
// });

// Run the initialize function when the window has finished loading.
// google.maps.event.addDomListener(window, 'load', initMap);



</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMxa7ucqwX08z6wLjiuAj_YdCtTnXjWYY&signed_in=true&callback=initMap&libraries=places"
  async defer>
</script>